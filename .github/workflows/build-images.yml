name: Build images

on:
  workflow_dispatch:
    inputs:
      push:
        description: "Push images to GHCR (default: false)"
        required: false
        default: "false"
  workflow_run:
    workflows: ['Check']
    types:
      - completed

defaults:
  run:
    shell: bash

jobs:
  docker-images:
    name: Build Docker images
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute tags
        id: vars
        run: |
          set -euo pipefail
          OWNER_LOWER="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            SHA="${{ github.sha }}"
            BRANCH="${{ github.ref_name }}"
          fi
          echo "owner=$OWNER_LOWER" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'master') || (github.event_name == 'workflow_dispatch' && inputs.push == 'true') }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & (optionally) push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'master') || (github.event_name == 'workflow_dispatch' && inputs.push == 'true') }}
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-backend:sha-${{ steps.vars.outputs.sha }}
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-backend:latest

      - name: Build & (optionally) push frontend image
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/Dockerfile
          push: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'master') || (github.event_name == 'workflow_dispatch' && inputs.push == 'true') }}
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-frontend:sha-${{ steps.vars.outputs.sha }}
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-frontend:latest
