name: Build images

on:
  workflow_dispatch:
    inputs:
      push:
        description: "Push images to GHCR"
        type: boolean
        required: false
        default: false
  workflow_run:
    workflows: ['Check']
    types:
      - completed

defaults:
  run:
    shell: bash

env:
  # `vars.*` values are strings. Also, `&&` returns operands (can be empty string), which breaks boolean-typed inputs like docker/build-push-action's `push`.
  # Force a strict boolean decision here.
  PUSH_IMAGES: ${{ (vars.PUSH_IMAGES == 'true') && ((github.event_name == 'workflow_dispatch' && inputs.push) || (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'master')) }}

jobs:
  docker-images:
    name: Build Docker images
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set frontend build args
        run: |
          set -euo pipefail

          if [ -n "${{ vars.LAUNCHER_NAME }}" ]; then
            LAUNCHER_NAME="${{ vars.LAUNCHER_NAME }}"
          else
            export "$(cat build.env | grep 'LAUNCHER_NAME=')"
            if [ -z "${LAUNCHER_NAME:-}" ]; then
              echo "LAUNCHER_NAME not set (vars.LAUNCHER_NAME or build.env)"
              exit 1
            fi
          fi
          echo "VITE_LAUNCHER_NAME=$LAUNCHER_NAME" >> "$GITHUB_ENV"

          if [ -n "${{ vars.VITE_API_BASE_URL }}" ]; then
            echo "VITE_API_BASE_URL=${{ vars.VITE_API_BASE_URL }}" >> "$GITHUB_ENV"
          else
            echo "VITE_API_BASE_URL=/api/v1" >> "$GITHUB_ENV"
          fi

          if [ -n "${{ vars.VITE_GITHUB_URL }}" ]; then
            echo "VITE_GITHUB_URL=${{ vars.VITE_GITHUB_URL }}" >> "$GITHUB_ENV"
          else
            echo "VITE_GITHUB_URL=https://github.com/Petr1Furious/potato-launcher" >> "$GITHUB_ENV"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute tags
        id: vars
        run: |
          set -euo pipefail
          OWNER_LOWER="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            SHA="${{ github.event.workflow_run.head_sha }}"
            BRANCH="${{ github.event.workflow_run.head_branch }}"
          else
            SHA="${{ github.sha }}"
            BRANCH="${{ github.ref_name }}"
          fi
          echo "owner=$OWNER_LOWER" >> "$GITHUB_OUTPUT"
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        if: ${{ fromJSON(env.PUSH_IMAGES || 'false') }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & (optionally) push backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile
          push: ${{ fromJSON(env.PUSH_IMAGES || 'false') }}
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-backend:sha-${{ steps.vars.outputs.sha }}
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-backend:latest

      - name: Build & (optionally) push frontend image
        uses: docker/build-push-action@v6
        with:
          context: frontend
          file: frontend/Dockerfile
          push: ${{ fromJSON(env.PUSH_IMAGES || 'false') }}
          build-args: |
            VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }}
            VITE_LAUNCHER_NAME=${{ env.VITE_LAUNCHER_NAME }}
            VITE_GITHUB_URL=${{ env.VITE_GITHUB_URL }}
          tags: |
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-frontend:sha-${{ steps.vars.outputs.sha }}
            ghcr.io/${{ steps.vars.outputs.owner }}/potato-launcher-frontend:latest
