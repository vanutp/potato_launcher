map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

map $http_x_forwarded_proto $forwarded_proto {
  default $http_x_forwarded_proto;
  ''      $scheme;
}

map $http_x_forwarded_for $forwarded_for {
  default $http_x_forwarded_for;
  ''      $proxy_add_x_forwarded_for;
}

map $http_x_real_ip $real_ip {
  default $http_x_real_ip;
  ''      $remote_addr;
}

map $http_x_forwarded_host $forwarded_host {
  default $http_x_forwarded_host;
  ''      $host;
}

server {
  listen 80;
  server_name _;
  client_max_body_size 300M;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $real_ip;
  proxy_set_header X-Forwarded-For $forwarded_for;
  proxy_set_header X-Forwarded-Proto $forwarded_proto;
  proxy_set_header X-Forwarded-Host $forwarded_host;
  proxy_http_version 1.1;

  # Legacy launcher auto-update endpoints
  location = /version_windows.txt { return 302 /api/v1/launchers/windows/exe/version; }
  location = /version_linux.txt   { return 302 /api/v1/launchers/linux/bin/version; }
  location = /version_macos.txt   { return 302 /api/v1/launchers/macos/archive/version; }

  location ~ ^/[^/]*launcher[^/]*\.exe$ { return 302 /api/v1/launchers/windows/exe; }
  location ~ ^/[^/]*launcher[^/]*_macos\.tar\.gz$ { return 302 /api/v1/launchers/macos/archive; }
  location ~ ^/(?!launcher$)[^/\.]*launcher[^/\.]*$ { return 302 /api/v1/launchers/linux/bin; }

  location / {
    root /usr/share/nginx/html;
    try_files $uri $uri/ /index.html;
    add_header Cache-Control "no-cache" always;
  }

  location /data/ {
    alias /var/www/generated/;
    autoindex on;
    try_files $uri $uri/ =404;
    add_header Cache-Control "public, max-age=60" always;
  }

  location /launcher/ {
    alias /var/www/launcher/;
    autoindex on;
    try_files $uri $uri/ =404;
    add_header Cache-Control "public, max-age=60" always;
  }

  location = /data {
    return 301 /data/;
  }
  location = /launcher {
    return 301 /launcher/;
  }

  location = /_auth {
    internal;
    proxy_pass http://backend:8000/api/v1/auth/check;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header Authorization "Bearer $cookie_pl_admin_token";
  }

  location /filebrowser/ {
    auth_request /_auth;
    proxy_pass http://filebrowser:80/;
    proxy_set_header X-Forwarded-Prefix /filebrowser;
  }

  location ~ ^/api/v\d+/ws {
    proxy_pass http://backend:8000;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    proxy_read_timeout 1h;
    proxy_send_timeout 1h;
  }

  location /api {
    proxy_pass http://backend:8000/api;
    proxy_set_header Authorization $http_authorization;
  }
}
